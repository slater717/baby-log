<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Feeding Log</title>
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      font:1rem/1.4 sans-serif;
      padding:1rem;
      background:#fff; color:#111;
      display:flex; flex-direction:column; height:100vh;
    }
    #buttons {
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:0.5rem;
      margin-bottom:0.5rem;
    }
    button {
      padding:1rem;
      font-size:1.1rem;
      background:#111; color:#fff;
      border:none; border-radius:4px;
      touch-action:manipulation;
    }
    #completeBtn {
      display:none;
      background:#007aff;
    }
    #sideTimers {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:0.5rem;
      margin-bottom:1rem;
    }
    .side-timer {
      text-align:center;
      font-size:0.9rem;
      color:#555;
    }
    #next {
      margin-bottom:1rem;
      font-weight:500;
    }
    #log {
      overflow:auto;
      flex:1;
    }
    .day {
      margin-top:1rem;
      font-weight:600;
    }
    .card {
      border:1px solid #ddd;
      border-radius:4px;
      padding:0.5rem;
      margin-top:0.5rem;
      display:flex; justify-content:space-between;
      background:#f9f9f9;
    }
    .incomplete { background:#ffe; }
  </style>
</head>
<body>
  <div id="buttons">
    <button data-side="left">Left</button>
    <button data-side="right">Right</button>
    <button id="completeBtn">Complete</button>
  </div>
  <div id="sideTimers">
    <div id="timer-left" class="side-timer"></div>
    <div id="timer-right" class="side-timer"></div>
  </div>
  <div id="next"></div>
  <div id="log"></div>

  <script>
    const STORAGE_EVENTS  = 'bfEvents';
    const STORAGE_CURRENT = 'bfCurrent';
    const INTERVAL_MS     = 3 * 60 * 60 * 1000;

    let events = JSON.parse(localStorage.getItem(STORAGE_EVENTS) || '[]');
    let current = JSON.parse(localStorage.getItem(STORAGE_CURRENT) || '{}');
    let timerId;

    function save() {
      localStorage.setItem(STORAGE_EVENTS, JSON.stringify(events));
      localStorage.setItem(STORAGE_CURRENT, JSON.stringify(current));
    }

    function fmtDate(ts) {
      return new Date(ts).toLocaleDateString(undefined, {
        month: 'short', day: 'numeric', year: 'numeric'
      });
    }

    function fmtTime(ts) {
      return new Date(ts).toLocaleTimeString(undefined, {
        hour: '2-digit', minute: '2-digit'
      });
    }

    function fmtElapsed(ms) {
      const m = String(Math.floor(ms / 60000)).padStart(2, '0');
      const s = String(Math.floor((ms % 60000) / 1000)).padStart(2, '0');
      return m + ':' + s;
    }

    function logSide(side) {
      if (!current[side]) {
        current[side] = Date.now();
        save();
        render();
      }
    }

    function completeFeed() {
      if (current.left && current.right) {
        events.push({ left: current.left, right: current.right });
        current = {};
        save();
        render();
      }
    }

    function updateTimers() {
      const now = Date.now();
      ['left', 'right'].forEach(side => {
        const el = document.getElementById('timer-' + side);
        if (current[side] && !(current.left && current.right)) {
          el.textContent = fmtElapsed(now - current[side]);
        } else {
          el.textContent = '';
        }
      });
    }

    function render() {
      clearInterval(timerId);
      updateTimers();
      timerId = setInterval(updateTimers, 1000);

      const logEl = document.getElementById('log');
      logEl.innerHTML = '';
      let lastDay = null;

      // Build display list: completed feeds + in-progress
      const list = events.map(f => Object.assign({complete: true}, f));
      if (current.left || current.right) {
        list.push(Object.assign({complete: false}, current));
      }

      list.reverse().forEach(feed => {
        const ts = feed.left || feed.right;
        const day = fmtDate(ts);
        if (day !== lastDay) {
          lastDay = day;
          const hdr = document.createElement('div');
          hdr.textContent = day;
          hdr.className = 'day';
          logEl.appendChild(hdr);
        }
        const card = document.createElement('div');
        card.className = 'card' + (feed.complete ? '' : ' incomplete');
        const leftTime = feed.left ? fmtTime(feed.left) : '–';
        let rightDisplay = '–';
        if (feed.complete) {
          const duration = Math.round((feed.right - feed.left) / 60000);
          rightDisplay = 'Complete ✅ (' + duration + ' min)';
        } else if (feed.right) {
          rightDisplay = fmtTime(feed.right);
        }
        card.innerHTML = '<div>' + leftTime + '</div><div>' + rightDisplay + '</div>';
        logEl.appendChild(card);
      });

      // Complete button
      document.getElementById('completeBtn').style.display =
        (current.left && current.right) ? 'block' : 'none';

      // Next feed
      const nextEl = document.getElementById('next');
      if (events.length) {
        const last = events[events.length - 1];
        const due = Math.max(last.left, last.right) + INTERVAL_MS;
        nextEl.textContent = 'Next feed at ' + fmtTime(due);
      } else {
        nextEl.textContent = '';
      }
    }

    // Event listeners
    document.querySelectorAll('button[data-side]').forEach(btn => {
      btn.addEventListener('click', () => logSide(btn.dataset.side));
    });
    document.getElementById('completeBtn')
      .addEventListener('click', completeFeed);

    render();
  </script>
</body>
</html>
